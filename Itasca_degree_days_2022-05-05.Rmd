---
title: "Degree Days"
author: "Sara DeLaurentis"
date: "5/5/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(stringr)
library(tidyverse)
library(lubridate)
library(ggplot2)
library(zoo)


```

## Data setup

```{r data setup}

## TEMPORARILY SET WORKING DIRECTORY TO "Itasca_project_19-21" !!!! ##

data <- read.csv("ALL.csv")

data$date.time <- data$date.time %>% as.POSIXlt(tz = "") #set date/time class to POSIXlt for greater ease in parsing date elements.
head(data$date.time)

# -- subset by date, add week-counting columns, calculate weekly means --

START <- as.POSIXlt("2020-10-01 00:00:00", tz = "") #trying the october 1-yr set to see if the code works. 5-5, SD
#BREAK <- as.POSIXlt("2020-08-25", tz = "")
#RESUME <- as.POSIXlt("2020-09-30", tz = "")
END <- as.POSIXlt("2021-10-01 00:00:00", tz = "")

data[is.na(data$value),] %>% #there should be a handful of NA's present if you're working with the right version of .csv files.
  print()

data <- data %>% 
  subset.data.frame(date.time >= START & date.time <= END) %>% #subset the whole df                         
  filter(!is.na(value))  # Apply filter & !is.na

# remove partial datasets for the given window. Anything with less than 500 values gets removed.
data <- data %>%
  group_by(site, rep, position) %>% 
  mutate(length = length(date.time)) %>% 
  filter(length > 500)


```

## 

```{r two}

daily.means.df <- data %>%
  group_by(site, rep, position, date(date.time)) %>% 
  summarise(date = date(date.time),
            name = name,
            site = site, 
            rep = rep, 
            position = position, 
            meantemp = round(mean(value), 2)) #BIG QUESTION: WHEN SHOULD I ROUND?
daily.means.df <- distinct(daily.means.df, site, rep, position, date, .keep_all = TRUE) %>% 
  ungroup()
daily.means.df$`date(date.time)` <- NULL

view(daily.means.df)
```
```{r}

daily.means.df <- daily.means.df %>% 
  filter(meantemp > 0) 
#only select days where mean temperature is greater than 0 

DD.df1 <- daily.means.df %>% 
  group_by(site, rep, position) %>% 
  summarise(site = site, #keep these columns: site, rep, position
            rep = rep,
            position = position, #create degree.days column by outputting the sum of meantemp for each position. (Not sensor, but position)
            degree.days = sum(meantemp))
  
DD.df2 <- daily.means.df %>% 
  group_by(site, rep, position, my(date)) %>% #may need to change the grouping to include a year element
    distinct(site, rep, position, .keep_all = TRUE) #remove duplicate rows.
view(DD.df2)
view(degree.days.df)
write_csv(degree.days.df, "degree_days_OCT_v1.csv") #write the csv file.


```

```{r}
#Change to factors
cols <- c("site", "rep", "position")
degree.days.df[cols] <- lapply(degree.days.df[cols], factor)



```

